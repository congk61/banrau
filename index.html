<!DOCTYPE html><html lang="vi"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; connect-src 'self' https://docs.google.com https://docs.googleusercontent.com https://spreadsheets.google.com https://corsproxy.io https://api.allorigins.win; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B√°n H√†ng Ch·ª£</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .product-card {
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
            background: white;
        }

        .product-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-5px);
        }

        .product-card.out-of-stock {
            opacity: 0.6;
            background: #f9f9f9;
        }

        .product-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .product-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .product-price {
            color: #e74c3c;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .product-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-out {
            background: #f8d7da;
            color: #721c24;
        }

        .add-to-cart {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .input-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 60px 1fr auto;
            gap: 15px;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            margin-bottom: 10px;
            align-items: center;
            background: white;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .cart-item-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .cart-item-details input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .cart-item-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .cart-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .cart-total h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .order-history {
            max-height: 600px;
            overflow-y: auto;
        }

        .order-card {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .order-date {
            font-weight: 600;
            color: #667eea;
        }

        .order-total {
            font-size: 18px;
            font-weight: 600;
            color: #e74c3c;
        }

        .order-items {
            font-size: 14px;
            color: #666;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .unit-list {
            display: grid;
            gap: 10px;
        }

        .unit-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            align-items: center;
        }

        .unit-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .add-unit-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-top: 15px;
        }

        .storage-info {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        .storage-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .storage-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .unit-selector {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .unit-selector button {
            flex: 1;
            min-width: 60px;
            padding: 6px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .unit-selector button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #dc3545;
        }

        .reload-btn {
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .product-grid {
                grid-template-columns: 1fr;
            }
            
            .cart-item {
                grid-template-columns: 1fr;
            }
            
            .add-to-cart {
                grid-template-columns: 1fr;
            }
            
            .add-unit-form {
                grid-template-columns: 1fr;
            }
            
            .unit-item {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Qu·∫£n L√Ω B√°n H√†ng Ch·ª£</h1>
            <p>H·ªá th·ªëng t√≠nh ti·ªÅn nhanh &amp; ch√≠nh x√°c</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('products')">üì¶ S·∫£n Ph·∫©m</button>
            <button class="tab" onclick="switchTab('cart')">üõí Gi·ªè H√†ng <span id="cart-count">(0)</span></button>
            <button class="tab" onclick="switchTab('orders')">üìã ƒê∆°n H√†ng</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è C√†i ƒê·∫∑t</button>
        </div>

        <div id="products" class="tab-content active">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m (c√≥ th·ªÉ g√µ kh√¥ng d·∫•u)..." onkeyup="searchProducts()">
            </div>
            <div id="products-loading" class="loading">
                <h3>‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...</h3>
            </div>
            <div id="products-error" style="display: none;"></div>
            <div id="products-list" class="product-grid"></div>
        </div>

        <div id="cart" class="tab-content">
            <div id="cart-items"></div>
            <div class="cart-total" id="cart-total-section" style="display: none;">
                <h2>T·ªïng ti·ªÅn: <span id="cart-total">0</span> ƒë</h2>
                <button class="btn btn-success" onclick="checkout()" style="margin-top: 15px; padding: 15px 30px; font-size: 16px;">‚úÖ Thanh To√°n</button>
                <button class="btn btn-danger" onclick="clearCart()" style="margin-top: 10px; padding: 10px 20px;">üóëÔ∏è X√≥a Gi·ªè H√†ng</button>
            </div>
            <div id="cart-empty" class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <h3>Gi·ªè h√†ng tr·ªëng</h3>
                <p>H√£y th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng</p>
            </div>
        </div>

        <div id="orders" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>L·ªãch S·ª≠ ƒê∆°n H√†ng</h2>
                <button class="btn btn-danger" onclick="clearOrderHistory()">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
            </div>
            <div id="order-history" class="order-history"></div>
        </div>

        <div id="settings" class="tab-content">
            <div class="settings-section">
                <h3>üìè Qu·∫£n L√Ω ƒê∆°n V·ªã</h3>
                <div id="units-list" class="unit-list"></div>
                <div class="add-unit-form">
                    <input type="text" id="new-unit-name" placeholder="T√™n ƒë∆°n v·ªã (VD: l·∫°ng)">
                    <input type="number" id="new-unit-rate" placeholder="Quy ƒë·ªïi sang kg (VD: 0.1)" step="0.01">
                    <button class="btn btn-primary" onclick="addUnit()">‚ûï Th√™m</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>üíæ Dung L∆∞·ª£ng L∆∞u Tr·ªØ</h3>
                <div class="storage-info">
                    <p><strong>ƒê√£ s·ª≠ d·ª•ng:</strong> <span id="storage-used">0</span> KB</p>
                    <p><strong>T·ªïng dung l∆∞·ª£ng:</strong> ~5000 KB (LocalStorage)</p>
                    <div class="storage-bar">
                        <div class="storage-bar-fill" id="storage-bar-fill"></div>
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        <span id="storage-percentage">0</span>% ƒë√£ s·ª≠ d·ª•ng
                    </p>
                </div>
            </div>

            <div class="settings-section">
                <h3>üìä Qu·∫£n L√Ω D·ªØ Li·ªáu</h3>
                <button class="btn btn-warning" onclick="loadProducts()" style="margin-right: 10px;">üîÑ T·∫£i L·∫°i D·ªØ Li·ªáu</button>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let cart = [];
        let orders = [];
        let units = [
            { name: 'kg', rate: 1 },
            { name: 'l·∫°ng', rate: 0.1 },
            { name: 'g√≥i', rate: 1 },
            { name: 'b√≥', rate: 1 }
        ];

        const DEFAULT_PRODUCT_IMAGE = 'https://via.placeholder.com/150?text=No+Image';

        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQoan7BE8OZRhivl2amxyW-jRgxROv5N2B_F98BkYaq1ZRv_tM3b_pJ_ktnZBsRarKJlf7xQIijJ5Y9/pub?output=csv';

        // Load data on startup
        window.onload = function() {
            loadFromLocalStorage();
            loadProducts();
            updateCartDisplay();
            updateOrderHistory();
            updateUnitsDisplay();
            updateStorageInfo();
        };

        function loadProducts() {
            document.getElementById('products-loading').style.display = 'block';
            document.getElementById('products-error').style.display = 'none';
            
            const fetchCsvText = async (url) => {
                const response = await fetch(url, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.text();
            };

            (async () => {
                try {
                    // 1) Th·ª≠ t·∫£i tr·ª±c ti·∫øp t·ª´ Google Sheets
                    const data = await fetchCsvText(SHEET_URL);
                    products = parseCSV(data);
                } catch (directErr) {
                    // 2) N·∫øu m·ªü b·∫±ng file:// ho·∫∑c b·ªã CORS, th·ª≠ qua proxy
                    try {
                        const proxiedUrl = `https://corsproxy.io/?${encodeURIComponent(SHEET_URL)}`;
                        const data = await fetchCsvText(proxiedUrl);
                        products = parseCSV(data);
                    } catch (proxyErr) {
                        try {
                            const proxiedUrl2 = `https://api.allorigins.win/raw?url=${encodeURIComponent(SHEET_URL)}`;
                            const data = await fetchCsvText(proxiedUrl2);
                            products = parseCSV(data);
                        } catch (proxyErr2) {
                            console.error('Error loading products (direct/proxy):', directErr, proxyErr, proxyErr2);
                            showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets (c√≥ th·ªÉ do CORS khi m·ªü b·∫±ng file://). H√£y th·ª≠ l·∫°i ho·∫∑c ch·∫°y b·∫±ng localhost.');
                            return;
                        }
                    }
                }

                if (!Array.isArray(products) || products.length === 0) {
                    showError('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m trong Google Sheets.');
                    return;
                }

                displayProducts(products);
                document.getElementById('products-loading').style.display = 'none';
                showNotification('‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu th√†nh c√¥ng!');
            })();
        }

        function showError(message) {
            const errorDiv = document.getElementById('products-error');
            errorDiv.innerHTML = `
                <div class="error-message">
                    <strong>‚ö†Ô∏è ${message}</strong>
                    <br><br>
                    <button class="btn btn-warning reload-btn" onclick="loadProducts()">üîÑ Th·ª≠ L·∫°i</button>
                </div>
            `;
            errorDiv.style.display = 'block';
            document.getElementById('products-loading').style.display = 'none';
        }

        function parseCSV(data) {
            const lines = data.split('\n');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length >= 5) {
                    const image = (values[5] || '').trim() || DEFAULT_PRODUCT_IMAGE;
                    result.push({
                        id: (values[0] || '').trim(),
                        name: (values[1] || '').trim(),
                        unit: (values[2] || '').trim(),
                        price: parseFloat(values[3]) || 0,
                        // Sheet c·ªßa b·∫°n d√πng TRUE/FALSE (c√≥ th·ªÉ c√≥ kho·∫£ng tr·∫Øng)
                        available: (values[4] || '').trim().toUpperCase() === 'TRUE',
                        image
                    });
                }
            }
            
            return result;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function removeVietnameseTones(str) {
            str = str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            str = str.replace(/ƒë/g, 'd').replace(/ƒê/g, 'D');
            return str.toLowerCase();
        }

        function searchProducts() {
            const searchTerm = removeVietnameseTones(document.getElementById('search-input').value);
            
            if (!searchTerm) {
                displayProducts(products);
                return;
            }
            
            const filtered = products.filter(product => 
                removeVietnameseTones(product.name).includes(searchTerm)
            );
            
            displayProducts(filtered);
        }

        function displayProducts(productList) {
            const container = document.getElementById('products-list');
            
            if (productList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <h3>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h3>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = productList.map(product => {
                const availableUnits = units.filter(u => u.rate > 0);
                const unitButtons = availableUnits.map(u => 
                    `<button class="${u.name === product.unit ? 'active' : ''}" onclick="selectUnit('${product.id}', '${u.name}')">${u.name}</button>`
                ).join('');
                
                return `
                    <div class="product-card ${!product.available ? 'out-of-stock' : ''}">
                        <img src="${product.image}" alt="${product.name}" class="product-image" onerror="this.src=DEFAULT_PRODUCT_IMAGE">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatCurrency(product.price)} / ${product.unit}</div>
                        <span class="product-status ${product.available ? 'status-available' : 'status-out'}">
                            ${product.available ? '‚úÖ C√≤n h√†ng' : '‚ùå H·∫øt h√†ng'}
                        </span>
                        <div class="unit-selector" id="unit-selector-${product.id}">
                            ${unitButtons}
                        </div>
                        <div class="add-to-cart">
                            <div class="input-group">
                                <label>S·ªë l∆∞·ª£ng</label>
                                <input type="number" id="qty-${product.id}" placeholder="0" step="0.1" min="0" onchange="updatePriceFromQty('${product.id}')" ${!product.available ? 'disabled' : ''}>
                            </div>
                            <div class="input-group">
                                <label>Th√†nh ti·ªÅn</label>
                                <input type="number" id="price-${product.id}" placeholder="0" step="1000" min="0" onchange="updateQtyFromPrice('${product.id}')" ${!product.available ? 'disabled' : ''}>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addToCart('${product.id}')" style="margin-top: 10px; width: 100%;" ${!product.available ? 'disabled' : ''}>
                            üõí Th√™m v√†o gi·ªè
                        </button>
                    </div>
                `;
            }).join('');
        }

        function selectUnit(productId, unitName) {
            const product = products.find(p => p.id == productId);
            if (!product) return;
            
            product.unit = unitName;
            
            const buttons = document.querySelectorAll(`#unit-selector-${productId} button`);
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.textContent === unitName);
            });
            
            const priceElement = document.querySelector(`#products-list .product-card:has(#unit-selector-${productId}) .product-price`);
            if (priceElement) {
                const basePrice = product.price;
                const unit = units.find(u => u.name === unitName);
                const convertedPrice = unit ? basePrice * unit.rate : basePrice;
                priceElement.textContent = `${formatCurrency(convertedPrice)} / ${unitName}`;
            }
            
            const qtyInput = document.getElementById(`qty-${productId}`);
            if (qtyInput && qtyInput.value) {
                updatePriceFromQty(productId);
            }
        }

        function updatePriceFromQty(productId) {
            const product = products.find(p => p.id == productId);
            const qty = parseFloat(document.getElementById(`qty-${productId}`).value) || 0;
            const unit = units.find(u => u.name === product.unit);
            const price = qty * product.price * (unit ? unit.rate : 1);
            document.getElementById(`price-${productId}`).value = Math.round(price);
        }

        function updateQtyFromPrice(productId) {
            const product = products.find(p => p.id == productId);
            const price = parseFloat(document.getElementById(`price-${productId}`).value) || 0;
            const unit = units.find(u => u.name === product.unit);
            const qty = price / (product.price * (unit ? unit.rate : 1));
            document.getElementById(`qty-${productId}`).value = qty.toFixed(2);
        }

        function addToCart(productId) {
            const product = products.find(p => p.id == productId);
            const qty = parseFloat(document.getElementById(`qty-${productId}`).value);
            const price = parseFloat(document.getElementById(`price-${productId}`).value);
            
            if (!qty || qty <= 0) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!');
                return;
            }
            
            const existingItem = cart.find(item => item.id == productId && item.unit === product.unit);
            
            if (existingItem) {
                existingItem.quantity += qty;
                existingItem.totalPrice = existingItem.quantity * product.price * (units.find(u => u.name === product.unit)?.rate || 1);
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    unit: product.unit,
                    unitPrice: product.price * (units.find(u => u.name === product.unit)?.rate || 1),
                    quantity: qty,
                    totalPrice: price || (qty * product.price * (units.find(u => u.name === product.unit)?.rate || 1)),
                    image: product.image
                });
            }
            
            document.getElementById(`qty-${productId}`).value = '';
            document.getElementById(`price-${productId}`).value = '';
            
            updateCartDisplay();
            saveToLocalStorage();
            
            showNotification('‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng!');
        }

        function updateCartDisplay() {
            const container = document.getElementById('cart-items');
            const countElement = document.getElementById('cart-count');
            const totalSection = document.getElementById('cart-total-section');
            const emptyState = document.getElementById('cart-empty');
            
            countElement.textContent = `(${cart.length})`;
            
            if (cart.length === 0) {
                container.innerHTML = '';
                totalSection.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            totalSection.style.display = 'block';
            
            container.innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <img src="${item.image}" alt="${item.name}" class="cart-item-image" onerror="this.src='https://via.placeholder.com/60?text=No+Image'">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                            ƒê∆°n gi√°: ${formatCurrency(item.unitPrice)} / ${item.unit}
                        </div>
                        <div class="cart-item-details">
                            <div>
                                <label style="font-size: 12px; color: #666;">S·ªë l∆∞·ª£ng (${item.unit})</label>
                                <input type="number" value="${item.quantity}" step="0.1" min="0" onchange="updateCartItem(${index}, 'quantity', this.value)">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">Th√†nh ti·ªÅn (ƒë)</label>
                                <input type="number" value="${Math.round(item.totalPrice)}" step="1000" min="0" onchange="updateCartItem(${index}, 'price', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="cart-item-actions">
                        <button class="btn btn-danger" onclick="removeFromCart(${index})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            document.getElementById('cart-total').textContent = formatCurrency(total);
        }

        function updateCartItem(index, type, value) {
            const item = cart[index];
            
            if (type === 'quantity') {
                item.quantity = parseFloat(value) || 0;
                item.totalPrice = item.quantity * item.unitPrice;
            } else if (type === 'price') {
                item.totalPrice = parseFloat(value) || 0;
                item.quantity = item.totalPrice / item.unitPrice;
            }
            
            updateCartDisplay();
            saveToLocalStorage();
        }

        function removeFromCart(index) {
            if (confirm('‚ùì B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
                cart.splice(index, 1);
                updateCartDisplay();
                saveToLocalStorage();
            }
        }

        function clearCart() {
            if (cart.length === 0) return;
            
            if (confirm('‚ùì B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?')) {
                cart = [];
                updateCartDisplay();
                saveToLocalStorage();
                showNotification('üóëÔ∏è ƒê√£ x√≥a gi·ªè h√†ng!');
            }
        }

        function checkout() {
            if (cart.length === 0) {
                alert('‚ö†Ô∏è Gi·ªè h√†ng tr·ªëng!');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            
            const order = {
                id: Date.now(),
                date: new Date().toLocaleString('vi-VN'),
                items: [...cart],
                total: total
            };
            
            orders.unshift(order);
            cart = [];
            
            updateCartDisplay();
            updateOrderHistory();
            saveToLocalStorage();
            
            alert(`‚úÖ Thanh to√°n th√†nh c√¥ng!\n\nT·ªïng ti·ªÅn: ${formatCurrency(total)} ƒë`);
            showNotification('üí∞ Thanh to√°n th√†nh c√¥ng!');
        }

        function updateOrderHistory() {
            const container = document.getElementById('order-history');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3>Ch∆∞a c√≥ ƒë∆°n h√†ng</h3>
                        <p>L·ªãch s·ª≠ ƒë∆°n h√†ng s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map((order, index) => `
                <div class="order-card">
                    <div class="order-header">
                        <span class="order-date">üìÖ ${order.date}</span>
                        <span class="order-total">${formatCurrency(order.total)} ƒë</span>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">
                                ‚Ä¢ ${item.name} - ${item.quantity} ${item.unit} √ó ${formatCurrency(item.unitPrice)} = ${formatCurrency(item.totalPrice)}
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 10px; text-align: right;">
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteOrder(${index})">üóëÔ∏è X√≥a</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteOrder(index) {
            if (confirm('‚ùì B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng n√†y?')) {
                orders.splice(index, 1);
                updateOrderHistory();
                saveToLocalStorage();
                showNotification('üóëÔ∏è ƒê√£ x√≥a ƒë∆°n h√†ng!');
            }
        }

        function clearOrderHistory() {
            if (orders.length === 0) return;
            
            if (confirm('‚ùì B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ ƒë∆°n h√†ng?')) {
                orders = [];
                updateOrderHistory();
                saveToLocalStorage();
                showNotification('üóëÔ∏è ƒê√£ x√≥a l·ªãch s·ª≠!');
            }
        }

        function updateUnitsDisplay() {
            const container = document.getElementById('units-list');
            
            container.innerHTML = units.map((unit, index) => `
                <div class="unit-item">
                    <input type="text" value="${unit.name}" onchange="updateUnit(${index}, 'name', this.value)" ${index < 2 ? 'disabled' : ''}>
                    <input type="number" value="${unit.rate}" step="0.01" onchange="updateUnit(${index}, 'rate', this.value)" ${index < 2 ? 'disabled' : ''}>
                    <button class="btn btn-danger" onclick="deleteUnit(${index})" ${index < 2 ? 'disabled' : ''}>üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateUnit(index, field, value) {
            if (field === 'name') {
                units[index].name = value;
            } else if (field === 'rate') {
                units[index].rate = parseFloat(value) || 0;
            }
            saveToLocalStorage();
            displayProducts(products);
        }

        function addUnit() {
            const name = document.getElementById('new-unit-name').value.trim();
            const rate = parseFloat(document.getElementById('new-unit-rate').value);
            
            if (!name || !rate || rate <= 0) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }
            
            if (units.some(u => u.name.toLowerCase() === name.toLowerCase())) {
                alert('‚ö†Ô∏è ƒê∆°n v·ªã n√†y ƒë√£ t·ªìn t·∫°i!');
                return;
            }
            
            units.push({ name, rate });
            document.getElementById('new-unit-name').value = '';
            document.getElementById('new-unit-rate').value = '';
            
            updateUnitsDisplay();
            saveToLocalStorage();
            displayProducts(products);
            showNotification('‚úÖ ƒê√£ th√™m ƒë∆°n v·ªã!');
        }

        function deleteUnit(index) {
            if (index < 2) return;
            
            if (confirm('‚ùì B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n v·ªã n√†y?')) {
                units.splice(index, 1);
                updateUnitsDisplay();
                saveToLocalStorage();
                showNotification('üóëÔ∏è ƒê√£ x√≥a ƒë∆°n v·ªã!');
            }
        }

        function updateStorageInfo() {
            const data = JSON.stringify({ cart, orders, units });
            const sizeKB = (new Blob([data]).size / 1024).toFixed(2);
            const maxSize = 5000;
            const percentage = ((sizeKB / maxSize) * 100).toFixed(2);
            
            document.getElementById('storage-used').textContent = sizeKB;
            document.getElementById('storage-percentage').textContent = percentage;
            document.getElementById('storage-bar-fill').style.width = Math.min(percentage, 100) + '%';
        }

        function saveToLocalStorage() {
            localStorage.setItem('cart', JSON.stringify(cart));
            localStorage.setItem('orders', JSON.stringify(orders));
            localStorage.setItem('units', JSON.stringify(units));
            updateStorageInfo();
        }

        function loadFromLocalStorage() {
            const savedCart = localStorage.getItem('cart');
            const savedOrders = localStorage.getItem('orders');
            const savedUnits = localStorage.getItem('units');
            
            if (savedCart) cart = JSON.parse(savedCart);
            if (savedOrders) orders = JSON.parse(savedOrders);
            if (savedUnits) units = JSON.parse(savedUnits);
        }

        function formatCurrency(amount) {
            return Math.round(amount).toLocaleString('vi-VN');
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>


</body></html>